define(["connector","/js/underscore-min.js","/js/jCanvaScript.1.5.15.js","http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"],function(e){function u(){jc.start("canvas",!0),t=jc.rect(0,0,window.innerWidth,window.innerHeight,"#131013",!0).id("background");for(var e in T)T[e]()}function l(){if(!n||!r)return;for(var e in o)o[e].del();o=[];for(var e in s)o.push(c(s[e]));for(var e in a)clearInterval(a[e]);a=[];for(var e in f)clearTimeout(f[e]);f=[];for(var e in n){var t=n[e];d(t)}}function c(e){var t=jc[e.type].apply(jc,e.constructor);return e.name&&t.name(e.name),e.id&&t.id(e.id),e.local&&t.animate({x:e.local.x*window.innerWidth,y:e.local.y*window.innerHeight}),t}function h(e){return 6e4/e}function p(e,t){return(e.start+e.duration)*h(t)}function d(t){var n=r.start+t.start*h(r.bpm),i=p(t,r.bpm),s=e.currentTime();n<=s&&(n+=Math.ceil((s-n)/i)*i);var o=setTimeout(function(){v(t);var e=setInterval(function(){v(t)},i);a.push(e)},n-s);f.push(o)}function v(e){for(var t in e.animations)m(e.selector,e.animations[t])}function m(e,t){setTimeout(function(){g(e,t)},t.start*h(r.bpm))}function g(e,t){var n=jc(e),i=h(r.bpm),s=t.duration*i;e.charAt(0)==="&"&&w[e]&&(n=w[e]);var o=[],u;for(var a=t.keypoints.length-1;a>=0;a--){var f=t.keypoints[a],l=f[0],c=0;a>0&&(c=t.keypoints[new Number(a)-new Number(1)][0]),u=y(f[1],(l-c)*s,f[2],u)}u.apply(n)}function y(e,t,n,r){return function(){if(t==0){if(_.isArray(this))for(var i in this)this[i].animate(e);else this.animate(e);r&&r()}else if(_.isArray(this))for(var i in this)this[i].animate(e,t,n,r);else this.animate(e,t,n,r)}}function b(e,t,n,r){return jc.circle(e,t,r||10,n||"#FFF",!0).name("user-circle")}function E(e,t){w["&"+t]||(w["&"+t]=[]),w["&"+t].push(e)}function S(e,t){var n=jc.image(flareImg,e,t,100,100).layer("star"),r=[[0,"rgba(249, 237, 220, 0.4)"],[.4,"rgba(249, 237, 220, 0.3)"],[.43,"rgba(249, 237, 220, 0.2)"],[1,"rgba(249, 237, 220, 0)"]],i=jc.rGradient(e+50,t+50,1,e+50,t+50,30,r).layer("star");E(i,"star-gradient");var s=jc.circle(e+50,t+50,50,i,!0).layer("star");return jc.layer("star")}function x(e){var t=r||{bpm:120},n=h(t.bpm);e.animate({r2:40},n,{type:"inOut",fn:"exp"},function(){this.animate({r2:30},n*3,{type:"inOut",fn:"exp"},function(){x(this)})})}var t,n,r,i=!0,s,o;$(function(){function t(){e.attr("height",window.innerHeight),e.attr("width",window.innerWidth)}var e=$("#canvas");$(window).resize(function(){t(),jc.clear(),u(),i=!0}),t(),u()}),e.socket.on("objects",function(e){s=e,i=!0}),e.socket.on("loops",function(e){n=e,i=!0}),e.socket.on("loop-stats",function(e){r=e,i=!0}),setInterval(function(){if(!i)return;i=!1,l()},1e3);var a=[],f=[],w={},T=[];return{background:t,createCircle:b,createStar:S,onActive:function(e){T.push(e)}}})